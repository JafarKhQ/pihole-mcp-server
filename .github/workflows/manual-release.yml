name: Build and Release

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
        type: string
      release_name:
        description: 'Release name'
        required: false
        type: string
        default: 'Release'
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      draft:
        description: 'Create as draft'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build JAR and Attach to Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release_tag }}

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Extract project info from pom.xml
        id: project_info
        run: |
          ARTIFACT_ID=$(mvn help:evaluate -Dexpression=project.artifactId -q -DforceStdout)
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "artifact_id=${ARTIFACT_ID}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Project: ${ARTIFACT_ID}"
          echo "Version: ${VERSION}"

      - name: Build with Maven
        run: mvn -B clean package -DskipTests --file pom.xml

      - name: List target directory
        run: ls -lh target/

      - name: Find and prepare JAR file
        id: prepare_jar
        run: |
          # Find the main JAR (exclude sources and javadoc)
          JAR_FILE=$(find target -type f -name "*.jar" \
            ! -name "*-sources.jar" \
            ! -name "*-javadoc.jar" \
            ! -name "original-*.jar" \
            | head -n 1)
          
          if [ -z "$JAR_FILE" ]; then
            echo "Error: No JAR file found!"
            exit 1
          fi
          
          JAR_NAME=$(basename ${JAR_FILE})
          JAR_SIZE=$(du -h ${JAR_FILE} | cut -f1)
          JAR_NAME_WITHOUT_EXT="${JAR_NAME%.jar}"
          
          echo "jar_path=${JAR_FILE}" >> $GITHUB_OUTPUT
          echo "jar_name=${JAR_NAME}" >> $GITHUB_OUTPUT
          echo "jar_name_no_ext=${JAR_NAME_WITHOUT_EXT}" >> $GITHUB_OUTPUT
          
          echo "Found JAR: ${JAR_FILE}"
          echo "JAR name: ${JAR_NAME}"

      - name: Create ZIP archive
        id: create_zip
        run: |
          ARTIFACT_ID="${{ steps.project_info.outputs.artifact_id }}"
          VERSION="${{ steps.project_info.outputs.version }}"
          JAR_FILE="${{ steps.prepare_jar.outputs.jar_path }}"
          JAR_NAME="${{ steps.prepare_jar.outputs.jar_name }}"
          
          # Create ZIP name: artifactId-version.zip
          ZIP_NAME="${ARTIFACT_ID}-${VERSION}.zip"
          
          # Create a temporary directory for packaging
          mkdir -p dist
          cp ${JAR_FILE} dist/${JAR_NAME}
          
          # Create ZIP
          cd dist
          zip -r ../${ZIP_NAME} ${JAR_NAME}
          cd ..
          
          echo "zip_name=${ZIP_NAME}" >> $GITHUB_OUTPUT
          echo "zip_path=${ZIP_NAME}" >> $GITHUB_OUTPUT
          
          echo "Created ZIP: ${ZIP_NAME}"
          ls -lh ${ZIP_NAME}

      - name: Generate checksums
        id: checksums
        run: |
          ZIP_FILE="${{ steps.create_zip.outputs.zip_path }}"
          
          # Generate MD5/SHA256
          md5sum ${ZIP_FILE} > ${ZIP_FILE}.md5
          sha256sum ${ZIP_FILE} > ${ZIP_FILE}.sha256
          
          # Store checksum value
          CHECKSUM=$(cat ${ZIP_FILE}.sha256 | cut -d' ' -f1)
          echo "sha256=${CHECKSUM}" >> $GITHUB_OUTPUT

      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.release_tag }}
          name: ${{ github.event.inputs.release_name }} ${{ github.event.inputs.release_tag }}
          body: |
            ## Release Information
            
            **Artifact:** ${{ steps.project_info.outputs.artifact_id }}  
            **Version:** ${{ steps.project_info.outputs.version }}  
            **Build Date:** ${{ github.event.head_commit.timestamp }}
            
            ## Download
            
            ðŸ“¦ **${{ steps.create_zip.outputs.zip_name }}**
            
            ## Verification
            
            Verify the downloaded file:
            
            ```bash
            sha256sum -c ${{ steps.create_zip.outputs.zip_name }}.sha256
            ```
            
            Expected SHA256:
            ```
            ${{ steps.checksums.outputs.sha256 }}
            ```
            
            ## Build Information
            - Java Version: 21
            - Built from commit: ${{ github.sha }}
            - Build Date: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          files: |
            ${{ steps.create_zip.outputs.zip_path }}
            ${{ steps.create_zip.outputs.zip_path }}.sha256
            ${{ steps.package.outputs.zip_path }}.md5
          draft: ${{ github.event.inputs.draft }}
          prerelease: ${{ github.event.inputs.prerelease }}
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Successfully built and released!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ steps.project_info.outputs.artifact_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.project_info.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Release Tag:** ${{ github.event.inputs.release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**ZIP File:** ${{ steps.create_zip.outputs.zip_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**SHA256:** \`${{ steps.checksums.outputs.sha256 }}\`" >> $GITHUB_STEP_SUMMARY
